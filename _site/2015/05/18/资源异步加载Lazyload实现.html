<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>资源异步加载Lazyload实现</title> <meta name="description" content="项目GIT地址 "> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://kylar.cn/2015/05/18/%E8%B5%84%E6%BA%90%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BDLazyload%E5%AE%9E%E7%8E%B0.html"> <link rel="alternate" type="application/rss+xml" title="Kylar" href="http://kylar.cn/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="我的作品">我的作品</li> <li class="sidebar-tag" data-filter="我的笔记">我的笔记</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="我的笔记" href="/jekyll/update/2015/05/25/%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F%20.html"> 垂直居中的几种方式 </a> <a class="toc-link" data-tags="我的作品" href="/2015/05/18/%E8%B5%84%E6%BA%90%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BDLazyload%E5%AE%9E%E7%8E%B0.html"> 资源异步加载Lazyload实现 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/05/14/%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E8%8A%82%E6%B5%81%E5%92%8C%E5%87%BD%E6%95%B0%E5%8E%BB%E6%8A%96.html"> 实现函数节流和函数去抖 </a> <a class="toc-link" data-tags="我的笔记 我的作品" href="/2015/04/23/%E7%94%A8EMCAScript6%E6%9D%A5%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97.html"> 用EMCAScript6来开发模块 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/04/15/js%E4%B8%ADnew%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html"> js中new关键字详解 </a> <a class="toc-link" data-tags="我的作品" href="/2015/04/01/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E8%B0%83%E8%AF%95%E9%9D%A2%E6%9D%BF-MinPanel%20.html"> 移动端调试面板-MinPanel </a> <a class="toc-link" data-tags="我的作品 我的笔记" href="/jekyll/update/2015/03/31/MinRequest-%E8%BD%BB%E9%87%8F%E5%8C%96jsonp%E8%B7%A8%E5%9F%9F%E5%AE%9E%E7%8E%B0.html"> MinRequest-轻量化jsonp跨域实现 </a> <a class="toc-link" data-tags="我的作品" href="/2015/03/28/mBaseCli-%E5%8E%9F%E5%AD%90%E5%8C%96%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html"> mBaseCli-原子化模块依赖解决方案 </a> <a class="toc-link" data-tags="我的笔记" href="/jekyll/update/2015/03/09/IOS-position-fixed.html"> iOS position fixed 在输入框获得焦点时定位失效 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/03/01/%E5%90%84%E7%A7%8Dheight:width%E6%95%B4%E7%90%86.html"> 各种height/width整理 </a> <a class="toc-link" data-tags="我的作品" href="/2015/02/13/FTP%E7%8E%AF%E5%A2%83%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B%E5%92%8C%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7.html"> FTP环境发布流程和版本管理工具 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/02/10/WebApp%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%86%E6%9E%90%E5%92%8C%E7%9C%8B%E6%B3%95.html"> WebApp发展趋势的一些分析和看法 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/02/02/%E4%BD%BF%E7%94%A8ES6+Babel+Broswerify%E8%BF%9B%E8%A1%8C%E5%BC%80%E5%8F%91.html"> 使用ES6+Babel+Broswerify进行开发 </a> <a class="toc-link" data-tags="我的笔记" href="/2015/01/19/BFC%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF.html"> BFC概念与实际应用场景 </a> <a class="toc-link" data-tags="我的作品" href="/2015/01/17/%E8%B7%A8%E7%BB%88%E7%AB%AF%E4%BB%A3%E7%90%86%E5%B7%A5%E5%85%B7-HttpProxyServer.html"> 跨终端代理工具-HttpProxyServer </a> <a class="toc-link" data-tags="我的作品" href="/2015/01/05/mBase%E8%A7%86%E8%A7%89%E6%A0%B7%E5%BC%8F%E5%BA%93.html"> mBase视觉样式库 </a> <a class="toc-link" data-tags="我的笔记" href="/2014/11/29/iframe%E8%B7%A8%E5%9F%9F%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%96%B9%E5%BC%8F.html"> iframe跨域参数传递方式 </a> <a class="toc-link" data-tags="我的笔记" href="/2014/11/09/AMD&CommonJS%E6%A8%A1%E5%9D%97%E6%A0%87%E5%87%86.html"> AMD&CommonJS模块标准 </a> <a class="toc-link" data-tags="我的笔记" href="/jekyll/update/2014/10/29/this%E4%B8%8E%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A8%A1%E5%BC%8F.html"> this与函数调用模式 </a> <a class="toc-link" data-tags="我的笔记" href="/2014/10/15/%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html"> 模块开发中的设计模式 </a> <a class="toc-link" data-tags="我的作品" href="/2014/09/23/%E8%BF%90%E8%90%A5%E7%BB%84%E4%BB%B6%E5%BA%93.html"> 运营组件库 </a> <a class="toc-link" data-tags="我的作品" href="/2014/08/27/%E7%AE%80%E5%8C%96%E6%B5%8F%E8%A7%88%E5%99%A8Url%E6%93%8D%E4%BD%9C--EasyUrl.html"> 简化浏览器Url操作--EasyUrl </a> <a class="toc-link" data-tags="我的作品" href="/2014/07/18/%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E9%97%B4%E5%88%86%E4%BA%AB%E9%A1%B5%E7%94%9F%E6%88%90%E6%9C%8D%E5%8A%A1.html"> 自动化中间分享页生成服务 </a> <a class="toc-link" data-tags="我的作品" href="/2014/07/05/Web-Compoents%E4%B8%AD%E6%96%87%E7%BD%91.html"> Web-Components中文网 </a> <a class="toc-link" data-tags="我的笔记" href="/2014/06/17/flexbox%E5%B8%83%E5%B1%80%E7%9A%84%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%AB%E5%92%8C%E4%BD%BF%E7%94%A8.html"> flexbox布局的版本区别和使用 </a> <a class="toc-link" data-tags="我的作品" href="/jekyll/update/2014/06/03/%E7%A7%BB%E5%8A%A8%E7%BB%84%E4%BB%B6%E6%96%87%E6%A1%A3%E7%B3%BB%E7%BB%9F.html"> 移动组件文档系统 </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2015 May 18</span> <span class="post-meta-span tag">我的作品</span> </div> <h1 class="post-title">资源异步加载Lazyload实现</h1> <p><a href="https://github.com/devWayne/Lazyload">项目GIT地址</a> </p> <h3 id="section">“懒加载”概述</h3> <p>资源异步加载也称 “懒加载”，在Web页面上图片或其他资源较多的情况，可以对这些资源延迟请求，来达到提升首屏页面加载时间的功能。对于用户来说，如果一个页面只看了首屏或者，前几屏，过多的资源加载是一种额外的负担或者说是流量上的浪费。目前主流的门户网站，无论是在PC或者是在移动端上，基本都使用了懒加载。</p> <h3 id="section-1">基本实现原理</h3> <p>首先，要监听用户屏幕的变化。大多数人可能都想到了<code>scroll</code>事件，在页面滑动的过程中触发的事件。除此之外，在PC端用户对浏览器进行缩放的时候，也会触发屏幕内容的变化，所以在这里监听了<code>scroll</code>和<code>resize</code>两种事件。</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;scroll&#39;</span><span class="p">,</span> <span class="nx">_scroll</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="nx">_scroll</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span></code></pre></div> <p>将事件触发时的滑动位置保存下来，在接下来计算图片是否在屏幕中位置时会用到。接下来通过变量<code>tikcing</code>判断事件回调是否已经在执行中，如果当次的回调还没有执行完，则不触发下次的回调。 </p> <p>需要注意的是在这里使用了一个<code>requestAnimationFrame</code>方法，这个方法的作用是让浏览器对当前的DOM操作（涉及重绘和重排）进行自动的合并和优化，减少CPU，GPU和内存的使用，在图片数量较多的情况优化较为明显。 </p> <p>附： <br /> <a href="http://caniuse.com/#feat=requestanimationframe">requestAnimationFrame的浏览器支持性</a> <br /> <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">requestAnimationFrame的定义</a> </p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_scroll</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastScroll</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">scrollY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ticking</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">_update</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ticking</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div> <p>再接下来就是对图片节点进行遍历，判断图片的当前位置和浏览器视图的当前位置，如果重合，将<code>data-lazyload</code>里面的value替换到<code>src</code>属性上，图片节点开始加载资源。遍历完成后，将<code>ticking</code>的值设为false，表示本身事件回调完成，可以进行下一次事件回调。 </p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_update</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">attr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_inViewport</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">v</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">attr</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">ticking</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></div> <p>最后来看一下比较浏览器当前位置和图片位置的方法，可以说是Lazyload实现的精髓所在 </p> <p>如果元素的底部位置高于视图的顶部并且元素的顶部小于视图的底部位置，就认为图片已经出现在视图中： </p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_inViewport</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">viewportTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastScroll</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">viewportBottom</span> <span class="o">=</span> <span class="nx">viewportTop</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">elementTop</span> <span class="o">=</span> <span class="nx">getOffsetTop</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">elementBottom</span> <span class="o">=</span> <span class="nx">elementTop</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">threshold</span> <span class="o">=</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">threshold</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">elementBottom</span> <span class="o">&gt;=</span> <span class="nx">viewportTop</span> <span class="o">-</span> <span class="nx">threshold</span> <span class="o">&amp;&amp;</span> <span class="nx">elementTop</span> <span class="o">&lt;=</span> <span class="nx">viewportBottom</span> <span class="o">+</span> <span class="nx">threshold</span>
<span class="p">}</span></code></pre></div> <p>关于获取元素对于doucment的相对位置： </p> <p>利用了<code>Element</code>的<code>offsetParent</code>方法进行遍历，冒泡到最外层的父元素上，将offset位置进行累加，获得的就是元素对于doucment的相对位置 </p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getOffsetLeft</span><span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">offsetLeft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
          <span class="nx">offsetLeft</span> <span class="o">+=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">offsetParent</span> <span class="p">);</span>
    <span class="k">return</span> <span class="nx">offsetLeft</span><span class="p">;</span>
<span class="p">}</span></code></pre></div> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://kylar.cn/2015/05/18/%E8%B5%84%E6%BA%90%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BDLazyload%E5%AE%9E%E7%8E%B0.html&text=资源异步加载Lazyload实现" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://kylar.cn/2015/05/18/%E8%B5%84%E6%BA%90%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BDLazyload%E5%AE%9E%E7%8E%B0.html&title=资源异步加载Lazyload实现" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://kylar.cn/2015/05/18/%E8%B5%84%E6%BA%90%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BDLazyload%E5%AE%9E%E7%8E%B0.html&title=资源异步加载Lazyload实现" target="_blank" class="post-share-icon weibo"></a> </div> </div> <div class="comment container"> <div id="disqus_thread"></div> <script type="text/javascript"> /* * * CONFIGURATION VARIABLES * * */ var disqus_shortname = 'devwayne'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a> </noscript> </div> <div class="footer"> <div class="container"> <p class="footer-entry">Copyright © 2015 kylar.cn Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> </body> </html>
